@page "/Public/registro-paciente"
@using DIGESA.Components.Pages.Componentes
@using DIGESA.Models.CannabisModels

<EditForm EditContext="@editContext" OnValidSubmit="@HandleValidSubmit"> 
    <DataAnnotationsValidator/>
    <ValidationSummary/>
    <div class="container-fluid my-4">
        <div class="card shadow-sm h-100">
            <div class="row g-0 h-100">
                <!-- Sidebar -->
                <div class="col-md-3 bg-light border-end p-4 position-sticky top-0">
                    <h5 class="fw-bold mb-4">
                        Formulario de Usuarios de Cannabis Medicinal y Acompañantes
                    </h5>

                    <!-- Progreso -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-uppercase fw-bold text-muted">Progreso</small>
                            <small class="fw-bold">@CurrentStepPercentage%</small>
                        </div>
                        <div class="progress" style="height:6px;">
                            <div class="progress-bar bg-success"
                                 role="progressbar"
                                 style="width:@CurrentStepPercentage%"
                                 aria-valuenow="@CurrentStepPercentage"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <!-- Steps -->
                    <nav class="nav flex-column small">
                        @for (var i = 1; i <= Steps.Count; i++)
                        {
                            <a class="nav-link d-flex align-items-center mb-3 p-2 rounded @(i == CurrentStepNumber ? "fw-bold text-dark bg-white" : "text-muted")"
                               href="#step@i">
                                <span class="me-3">@i.</span>
                                @Steps[i - 1]
                            </a>
                        }
                    </nav>
                </div>

                <!-- Contenido Principal -->
                <div class="col-md-9 p-4">
                    <div id="step@CurrentStepNumber" class="mb-4">
                        @if (CurrentStepNumber == 1)
                        {
                            <PacienteStep @ref="pacienteComponent"
                                          Registro="@registro"
                                          PacienteProvinciasList="@pacienteProvinciaslist"
                                          PacienteDistritoList="@pacienteDistritolist"
                                          PacienteCorregimientoList="@pacienteCorregimientolist"
                                          PacienteRegionesList="@pacienteRegioneslist"
                                          MostrarOtraInstalacionPaciente="@mostrarOtraInstalacionPaciente"
                                          InstalacionFilterPaciente="@instalacionFilterPaciente"
                                          OnPacienteProvinciaChanged="@HandlePacienteProvinciaChanged"
                                          OnPacienteDistritoChanged="@HandlePacienteDistritoChanged"
                                          OnAutoCompletePacienteChanged="@HandleAutoCompletePacienteChanged"
                                          OnMostrarOtraInstalacionPacienteChanged="@HandleMostrarOtraInstalacionPacienteChanged"
                                          AutoCompleteDataProvider="@AutoCompleteDataProvider" />
                        }
                        else if (CurrentStepNumber == 2 && registro.Paciente.RequiereAcompanante == EnumViewModel.RequiereAcompanante.Si)
                        {
                            <AcompananteStep @ref="acompananteComponent"
                                             Registro="@registro" />
                        }
                        else if (CurrentStepNumber == 3 || (CurrentStepNumber == 2 && registro.Paciente.RequiereAcompanante != EnumViewModel.RequiereAcompanante.Si))
                        {
                            <MedicoStep @ref="medicoComponent"
                                        Registro="@registro"
                                        MostrarOtraInstalacionMedico="@mostrarOtraInstalacionMedico"
                                        InstalacionFilterMedico="@instalacionFilterMedico"
                                        OnAutoCompleteMedicoChanged="@HandleAutoCompleteMedicoChanged"
                                        OnMostrarOtraInstalacionMedicoChanged="@HandleMostrarOtraInstalacionMedicoChanged"
                                        AutoCompleteDataProvider="@AutoCompleteDataProvider" />
                        }
                        else if (CurrentStepNumber == 4)
                        {
                            <DiagnosticoStep @ref="diagnosticoComponent"
                                             Registro="@registro"
                                             PacienteDiagnosticoList="@pacienteDiagnosticolist"
                                             ProductoFormaList="@productoFormaList"
                                             ProductoUnidadList="@productoUnidadList"
                                             ProductoViaConsumoList="@productoViaConsumoList"
                                             OnUnidadSeleccionadaChanged="@(async (e) => await HandleUnidadSeleccionadaChanged(e))" />
                        }
                        else if (CurrentStepNumber == 5)
                        {
                            <ComorbilidadStep @ref="comorbilidadComponent"
                                              Registro="@registro" />
                        }
                        else if (CurrentStepNumber == 6)
                        {
                            <ArchivoStep @ref="archivosComponent"
                                         TipoTramite="@tipoTramite"
                                         TipoTramiteChanged="@(async (value) => tipoTramite = value)"
                                         Documentos="@documentos"
                                         OnFileChange="@HandleFileChange" />
                        }

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-5">
                            <!-- Botón ATRÁS -->
                            <button type="button"
                                    class="btn btn-outline-success px-4"
                                    @onclick="HandlePreviousStep"
                                    disabled="@(CurrentStepNumber == 1)">
                                ATRÁS
                            </button>

                            @if (CurrentStepNumber == Steps.Count)
                            {
                                <!-- Botón ENVIAR SOLO EN EL ÚLTIMO PASO -->
                                <button type="submit"
                                        class="btn btn-success px-4">
                                    GUARDAR SOLICITUD
                                </button>
                            }
                            else
                            {
                                <!-- Botón SIGUIENTE -->
                                <button type="button"
                                        class="btn btn-success px-4"
                                        @onclick="HandleNextStep">
                                    SIGUIENTE
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</EditForm>
<ConsentimientoCannabisModal @ref="ConsentimientoModal"
                             OnDecision="HandleConsentimientoDecision" />

<DynamicModal @ref="ModalForm" />
